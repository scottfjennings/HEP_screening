

## this code takes the raw HEP site visit data from the hep_raw access database, and creates a multi-sheet excel file that allows the manual screening of nests
## the sheets created are:
## 1. The scoring sheet: Either 1 sheet, named 'nests' (for colonies with few nests or species), or a sheet for each species (for large and multi-species colonies) that is equivalent to the handwritten scoring sheet, plus some fields generated by the nest screening algorithm that serve as helpers for the manual screening; the user determines whether 1 or multiple sheets are generated. This sheet has the following fields:
    # species code
    # nest ID
    # columns for each day the nest was checked showing the number of adults, status, number of chicks, and confidence in chick count
    # 'focal' =  yes/no (1/0) for whether the nest meets the basic requirements for being focal
    # 'focal fail' = yes/no (1/0) for whether a nested classified as focal failed
    # 'fledged = yes/no (1/0) for nests likely to have fledged (reached min fledge age in either stage 4 or 5), 
    # 'days_short_of_fledging' = for nests that didn't clearly fail but were observed innactive earlier than expected, the number of days from the last date it was observed active until the expecteed fledge date; 
    # 'active_last_day' = yes/no (1/0) indicating if nest was still active on the last day it was checked
    # 'max_stage' = maximum stage teh nest was observed in
    # 'num_spp' = number of species assigned to this nest ID- helps find where observer might have been confused about which nest was which, or true species turnovers
    # 'stg4_brood' = maximum confidently observed stage 4 brood size

## 2. peak_active: shows the date, julian date, and number of nests for the peak active date for each species

## 3. stg4: number of stage 4 nests of each brood size for each species

## 4. nest_num_stage: number of nests of each species in each stage on each date the colony was checked

## 5. num_active: total number of active nests for each species on each date the colony was checked
#--------------------

## once the libraries are loaded, the working directory set (this and the pathway in the read_csv function will need to be changed depending on each user's computer), and the colony and season info have been set, then everything down to 'RUN TO HERE FIRST' around line 415 can be run

## then the decision about how many scoring sheets to write can be made, and the final xls file can be written back to the working directory (be sure to check the file path there too)

#--------------------
## load the required packages
library(plyr)
library(tidyverse)
library(reshape2)
library(lubridate)
library(xlsx)
library(readxl)
library(hms)

#-----------
#specify which colony and season you want to work with
col="Alcatraz" # this needs to match the site_name field in the code_data_files/sub_sites.csv file; if the colony you're working on doesn't have a site_name yet, you can create one that makes sense (a shorter version of the colony name, with no spaces for best use as a file name); be sure to add this new site_name to the sub_sites file.
col.code="70"
seas="2015"

#-----------
##importing from hep_raw access database
## (in access, run HEP_individual nests Query, export to xls, then save as csv)

hep_all=read.csv("queried_from_access/HEP_individual nests Query.csv") 

names(hep_all) <- tolower(names(hep_all))


#-----------
## data management
hep_all <- hep_all %>% 
  mutate(nest = as.character(nest), ## to allow non-numerical nest IDs
         date = mdy(date), # fix format of date field
         stage = ifelse(is.na(stage), 0, stage), # fill in missing data
         adults = ifelse(is.na(adults), 0, adults), 
         chicks = ifelse(is.na(chicks), 0, chicks), 
         confidence = ifelse(is.na(confidence), 9, confidence)) %>% 
  select(species = speciescode, everything())


## here can add in 2015 and 2016 data from csvs (single object generated with 'hep_screen_from_field_data.R' and with a copy saved at HEP_screening/code_data_files/2015_2016_nests.csv)
## be sure to edit the file path for your computer
csv_nests <- read_csv("code_data_files/2015_2016_nests.csv", col_types = cols(code = col_character())) %>% 
  mutate(code = as.numeric(code))

hep_all <- bind_rows(hep_all, csv_nests)



## and make a few new fields
hep_all <- hep_all %>% 
  mutate(jdate = yday(date), # create Julian date
         md=paste(month(date), day(date), sep = "-"), # create a fiedld for Month-Day
# this next one creates the field to be displayed in the nest Scoring Form
# combining number of adults, stage, number of chicks, and a * if confidence was checked,
# or just status and adults if the nest was called something other than active
          ad.stg.chx.conf=ifelse(status=="A", ifelse(confidence==1, 
                                           paste(adults, " ", paste(stage, chicks, sep="/"), "*", sep=""), 
                                           paste(adults, paste(stage, chicks, sep="/"), sep=" ")),
                       paste(status, adults, sep = "-")))



## double check which years and colonies are present
#hep_checker <- hep_all %>% 
#  mutate(Year = year(date)) %>% 
#  distinct(code, Year)



#-----------
## filter to just the colony and season you want to work with
hep <- hep_all %>% 
  filter(code==col.code, year(date) == seas) %>%
  droplevels()


#-----------
# if screening Alcatraz data (output from S:\Databases\HEP_site_visits\Alcatraz\alcatraz.r), then start here
alcatraz_hep=read.csv(paste("S:/Databases/HEP_site_visits/Alcatraz/Alcatraz_ready4screening/alcatraz", seas, "_4screening.csv", sep = "")) 



hep <- alcatraz_hep %>% 
  mutate(status = as.character(status),
         nest = as.character(nest), ## to allow non-numerical nest IDs
         date = ymd(as.character(date)), # fix format of date field
         jdate = yday(date), # create Julian date
         md = paste(month(date), day(date), sep = "-"), # create a field for Month-Day
         # this next one creates the field to be displayed in the nest Scoring Form
         # combining number of adults, stage, number of chicks, and a * if confidence was checked,
         # or just status and adults if the nest was called something other than active
         ad.stg.chx.conf = ifelse(status == "I", status, paste(stage, chicks, sep="/"))) %>% 
  filter(!is.na(spp)) %>% 
  rename(species = spp)



#-----------
## for each visit, make table with the number of nests in each stage
## gets written to final xls
nest_num_stage=hep %>% 
	filter(status=="A") %>%
    group_by(species, date, stage) %>%	
	summarise(num_nests = length(nest)) %>% 
  spread(date, num_nests)
names(nest_num_stage) <- gsub(paste(seas, "-", sep = ""),"",names(nest_num_stage))
nest_num_stage[is.na(nest_num_stage)] <- "-"


#-----------
## make wide version of the number of nests of all status for each species on each visit	
## gets written to final xls
num_active_wide <- hep %>% 
  filter(status=="A") %>%
  group_by(species, date) %>%	
  summarise(num_active = length(nest))  %>%  
  spread(date, num_active) 
names(num_active_wide) <- gsub(paste(seas, "-", sep = ""),"",names(num_active_wide))
num_active_wide[is.na(num_active_wide)] <- "-"


#-----------
## determine the date with the peak number of active nests, and PEAKACTVNSTS
## gets written to final xls
peak_active <- hep %>% 
  filter(status=="A") %>%
  group_by(species, date) %>%	
  summarise(num_active = length(nest))  	%>%
	group_by(species) %>%
	filter(num_active==max(num_active)) %>%
	filter(date==min(date)) %>% 
  mutate(peak_active_jdate = yday(date)) %>% 
  select(species, peak_active_date = date, peak_active_jdate, PEAKACTVNSTS = num_active)


#-----------
## make the df used by the nest screening algorithm
make_nests4screening <- function(){

# create df with the minimum fledging age and duration of incubation for each species
  sp_stats1=data.frame(species=c('BCNH', 'SNEG', 'CAEG', 'GREG', 'GBHE', 'DCCO'),
                       min_fl=as.numeric(c('40', '34', '38', '77', '84', NA)),
                       inc_dur=as.numeric(c('25', '22', '24', 	'28', '28', NA))
  )
  

# make several fields that will be used for automated screening 
# determine the latest date of observations for each species
spp_max_jdate=hep %>% 
	filter(status=="A") %>%
    group_by(species) %>%
	summarise(spp_max_jdate = max(jdate)) 

# create a df with the general species info (min_fl and inc_dur) and the colony-specific species info (peak_active and spp_max_jdate)
spp_stats <- full_join(peak_active, spp_max_jdate) %>% 
                  inner_join(., sp_stats1)

# create unique list of each species+nest combo
spp.nests2=unique(hep[c("species", "nest")])

# merge unique nest list with the species info
spp.nests1=full_join(spp.nests2, spp_stats)
#----------
# ID nests that were assigned to more than 1 species
multi_spp_nests=hep %>% 
	filter(status=="A") %>%
    group_by(nest) %>%
    summarise(num_spp=n_distinct(species))	
#----------
# determin the maximum stage each nest was observed in	
max_stage=hep %>% 
	filter(status=="A") %>%
    group_by(species, nest) %>%	
	summarise(max_stage = max(stage)) 
#----------	
# determin the minimum stage each nest was observed in		
min_stage=hep %>% 
	filter(status=="A") %>%
    group_by(species, nest) %>%	
	summarise(min_stage = min(stage)) 
#----------	
# determin the minimum stage each nest was observed with chick		
min_stage_chx=hep %>% 
	filter(status=="A", stage>1) %>%
    group_by(species, nest) %>%	
	summarise(min_stage_chx = min(stage)) 
#----------
# determin the latest date each nest was observed	
latest_date=hep %>% 
	filter(status=="A") %>%
    group_by(species, nest) %>%	
	summarise(latest_date = max(jdate)) 
#----------
# determin the earliest date each nest was observed	
earliest_date=hep %>% 
	filter(status=="A") %>%
    group_by(species, nest) %>%	
	summarise(earliest_date = min(jdate)) 
#----------
# determin the latest date each nest was observed in stage 1	
latest_date_stage1=hep %>% 
	filter(status=="A") %>%
    group_by(species, nest) %>%
	filter(stage==1) %>%
	summarise(latest_date_stage1 = max(jdate)) 
#----------
# determin the latest date each nest was observed in stage 4 or later
latest_date_unguarded=hep %>% 
	filter(status=="A") %>%
    group_by(species, nest) %>%
	filter(stage>3) %>%
	summarise(latest_date_unguarded = max(jdate)) 
#----------
# determin the earliest date each nest was observed in stage 1
earliest_date_stage1=hep %>% 
	filter(status=="A") %>%
    group_by(species, nest) %>%
	filter(stage==1) %>%
	summarise(earliest_date_stage1 = min(jdate))	
#----------
# determin the earliest date each nest was observed with chicks (later than stage 1)
earliest_date_chx=hep %>% 
	filter(status=="A") %>%
    group_by(species, nest) %>%
	filter(stage>1) %>%
	summarise(earliest_date_chx = min(jdate))	
#----------
# determin the stage 4 brood size of each nests (where knowable)
if(col == "Alcatraz") {
  # alcatraz option
stg4_brood=hep %>% 
	filter(status=="A") %>%
  group_by(species, nest) %>%	
	filter(stage==4) %>%
	filter(jdate==max(jdate)) %>%
	select(species, nest, stg4_brood = chicks) 
} else {
  stg4_brood=hep %>% 
	filter(status=="A") %>%
  group_by(species, nest) %>%	
	filter(stage==4, confidence==1) %>%
	filter(jdate==max(jdate)) %>%
	select(species, nest, stg4_brood = chicks) 
}

#----------
#determin the earliest stage a nest was observed in	
earliest_stage=hep %>% 
	filter(status=="A") %>%
    group_by(species, nest) %>%	
	filter(jdate==min(jdate)) %>%
	select(species, nest, earliest_stage = stage) 
	
## bind all those created objects
nests1 <- join_all(list(spp.nests1, earliest_date_chx, earliest_stage, min_stage_chx, earliest_date_stage1, latest_date_stage1, latest_date_unguarded, max_stage, latest_date, earliest_date, stg4_brood), type = 'full')
nests <- join_all(list(nests1, multi_spp_nests), type = 'full')



return(nests)
}
nests4screening <- make_nests4screening()


#-----------
# make automated screening calculations
screened_nests <- nests4screening %>%  
  mutate(
	# was the nest still active on the last day of nest checks for this species?
	active_last_day = ifelse(latest_date==spp_max_jdate, 1, 0),
	#meets criteria for focal nest 
	focal = ifelse(# nest was observed active before peak colony size
	              earliest_date <= peak_active_jdate &
	             # nest was observed before hatching
								earliest_stage < 2 & 
							 # nest actually reached incubation or brooding
								max_stage > 0 & 
								  # nest was first observed during the first 2 weeks of incubation or earlier
									(((earliest_date <= round(earliest_date_chx - (inc_dur - 14), 0)) & min_stage_chx < 4 ) | 
									# or the first day chicks were observed they were still being guarded
										(earliest_date <= round(latest_date_stage1 - (inc_dur - 14),0))), 1, 0),	   
																							   # | means or
											   
	# did the nest reach the minimum fledging age
	fledged = ifelse(latest_date_unguarded-earliest_date_stage1 > min_fl, 1, 0),
	fledged = ifelse(is.na(fledged), 0, fledged),
	

	# was it a focal nest that failed?
	focal_fail = ifelse(focal == 1 & active_last_day == 0 & fledged == 0, 1, 0),  

	#count number of days short of fledging the nest was observed
	days_short_of_fledging = ifelse(max_stage > 3 & fledged == 0,(latest_date_unguarded-earliest_date_stage1) - min_fl, "")
  )


#-----------
# count focal fails detected on each visit
make_foc_fails <- function(){
# first determin which dates each species was surveyed
survey_dates=hep %>% 
	distinct(species,date) 
	
# then determine the final day observed for each focal nest that failed
focal_fail_dates=screened_nests %>% 
  filter(focal_fail==1) %>% 
  group_by(species, latest_date) %>%
	summarize(num_fails = length(nest)) %>% 
  mutate(date = (as.Date(paste(seas,"-01-01", sep="")) + latest_date)-1) #get date back from julian date
# join 	
zdates <- full_join(focal_fail_dates, survey_dates)
# this finds the next day after the last day a failed focal nest was observed active, which is the first day it was observed failed,
# then makes it into wide format for output to the xls
focal_fail_dates_wide <- zdates %>%
  arrange(species, date) %>% 
  mutate(next_date = lead(date),
         next_md = paste(month(next_date), day(next_date), sep="-"),
         next_md = ifelse(next_md=="NA-NA", "", next_md)) %>% 
  select(species, num_fails, next_md) %>% 
  filter(num_fails>0) %>% 
  spread(next_md, num_fails)
return(focal_fail_dates_wide)
}
focal_fail_dates_wide <- make_foc_fails()	

## getting this error is OK; it just means there were no focal failures
#  Error in enc2utf8(col_names(col_labels, sep = sep)) : 
#   argument is not a character vector


#-----------
# make the nest Scoring Form
make_nest_scoring <- function(){
  # extract just the fields from 'nests' needed to export
  nests.sub=subset(screened_nests, select=c("species", "nest", "focal", "focal_fail", "fledged", "days_short_of_fledging", "active_last_day", "max_stage", "num_spp", "stg4_brood"))
  
hep.wide <- hep %>% 
  arrange(species, date) %>% 
  select(date, species, nest, ad.stg.chx.conf) %>%
  unique() %>% 
  spread(date, ad.stg.chx.conf)
names(hep.wide) <- gsub(paste(seas, "-", sep = ""),"",names(hep.wide))

hep.wide1=full_join(hep.wide, nests.sub)
return(hep.wide1)
}
hep.wide1 <- make_nest_scoring()


#-----------
# Number of stage 4 nests of each brood size
## gets written to final xls
stg4_wide = hep.wide1 %>%
	group_by(species, stg4_brood) %>%
	summarize(num_nests = length(nest)) %>% 
  filter(stg4_brood>0)%>% 
  mutate(stg4_brood = paste("BRD", stg4_brood, sep = "")) %>% 
  spread(stg4_brood, num_nests) 
stg4_wide[is.na(stg4_wide)] = 0


#-----------
####  NOW FOR THE VISITS DATA
# won't work for Alcatraz
## gets written to final xls
hep.visits <- read_xlsx("queried_from_access/HEP_visits Query.xlsx", "HEP_visits_Query")

#hep.visits <- read_csv("HEP_screening/queried_from_access/HEP_visits Query.csv")
names(hep.visits) <- tolower(names(hep.visits))
hep.visits <- hep.visits %>% 
  mutate(date = as.Date(date, format = "%d-%b-%y"),
         endtime = as.hms(endtime),
         starttime = as.hms(starttime))


csv_visits <- read.csv("code_data_files/2015_2016_visits.csv")
csv_visits <- csv_visits  %>% 
  mutate(date = as.character(date),
         date = ymd(date),
         endtime = as.character(endtime),
         endtime = as.hms(endtime),
         starttime = as.character(starttime),
         starttime = as.hms(starttime),
         obsinitial = as.character(obsinitial),
         speciescode = as.character(speciescode)) %>% 
  select(code, date, obsinitial, starttime, endtime, speciescode, active, possiblyactive)

hep.visits <- bind_rows(hep.visits, csv_visits)

make_visits <- function(){

hep.visits <- hep.visits %>% 
  mutate(#e_time = as.hms(endtime),
         #s_time = as.hms(starttime),
         surveytime = (endtime-starttime)/60/60) %>% 
  select(species = speciescode, everything())

hep.visits.sub <- hep.visits %>% 
  filter(code==col.code, year(date) == seas) %>%
  droplevels()

totobsdays=hep.visits.sub %>% 
  group_by(species) %>%
  summarize(days = length(starttime))	

totobshours=hep.visits.sub %>% 
  group_by(species) %>%
  summarize(hours = sum(surveytime)) %>% 
  mutate(hours = round(hours, 1))

visits <- full_join(totobsdays, totobshours)
return(visits)

}
visits <- make_visits()


##----------
## replace all the NAs with blank to make the xls output tidier
hep.wide1[is.na(hep.wide1)] <- ""
focal_fail_dates_wide[is.na(focal_fail_dates_wide)] <- ""
## getting this error is OK; it just means there were no focal failures
# Error in focal_fail_dates_wide[is.na(focal_fail_dates_wide)] <- "" : 
# object 'focal_fail_dates_wide' not found
nest_num_stage[is.na(nest_num_stage)] <- ""
num_active_wide[is.na(num_active_wide)] <- ""
stg4_wide[is.na(stg4_wide)] <- ""



#################		RUN TO HERE FIRST		################

### look at numer of nests for each species to decide whether final xlsx should have spp lumped or in different sheets.
### then run export.hep()  and desired appender functions below
hep %>%
		group_by(species, nest) %>%
		select(species, nest) %>%
		unique() %>% 
  group_by(species) %>%
  summarise(num_nests = n()) %>% 
  data.frame()

### look at numer of multi-species nests to decide whether final xlsx should have sheet for those.
hep.wide1 %>% filter(num_spp>1) %>% nrow()

##-------------------------------------


# need to make all the tbls into dfs for write.xlsx  
hep.wide1 <- as.data.frame(hep.wide1)
peak_active <- as.data.frame(peak_active)
stg4_wide <- as.data.frame(stg4_wide)
nest_num_stage <- as.data.frame(nest_num_stage)
num_active_wide <- as.data.frame(num_active_wide)
visits <- as.data.frame(visits) 
# set path for file to be written to
zfile <- paste("S:/Databases/HEP_site_visits/codeAndSupportingFiles_for_HEP_screening/scoring_files/", paste(seas, col, sep="/"), "_scoring.xlsx", sep="")



### load these funtions to write the scoring file with the base sheets (export.hep()) and then the appender functions
## the functions are actually called (executed) below
export.hep=function(){
write.xlsx(peak_active, file=zfile, sheetName="peak_active", append=TRUE, row.names=FALSE)
write.xlsx(stg4_wide, file=zfile, sheetName="stg4", append=TRUE, row.names=FALSE)
write.xlsx(nest_num_stage, file=zfile, sheetName="nest_num_stage", append=TRUE, row.names=FALSE)
write.xlsx(num_active_wide, file=zfile, sheetName="num_active", append=TRUE, row.names=FALSE)
 }

append.all.spp=function(){
  write.xlsx(hep.wide1, file=zfile, sheetName="nests", row.names=FALSE)
  }
append.bcnh=function(){
  write.xlsx(hep.wide1[hep.wide1$species=="BCNH",], file=zfile, sheetName="BCNH", append=TRUE, row.names=FALSE)
  }
append.caeg=function(){
  write.xlsx(hep.wide1[hep.wide1$species=="CAEG",], file=zfile, sheetName="CAEG", append=TRUE, row.names=FALSE)
  }
append.greg=function(){
  write.xlsx(hep.wide1[hep.wide1$species=="GREG",], file=zfile, sheetName="GREG", append=TRUE, row.names=FALSE)
  }
append.sneg=function(){
  write.xlsx(hep.wide1[hep.wide1$species=="SNEG",], file=zfile, sheetName="SNEG", append=TRUE, row.names=FALSE)
  }
append.gbhe=function(){
  write.xlsx(hep.wide1[hep.wide1$species=="GBHE",], file=zfile, sheetName="GBHE", append=TRUE, row.names=FALSE)
  }
append.dcco=function(){
  write.xlsx(hep.wide1[hep.wide1$species=="DCCO",], file=zfile, sheetName="DCCO", append=TRUE, row.names=FALSE)
  }
append.multi.spp=function(){ 
  write.xlsx(hep.wide1[hep.wide1$num_spp>1,], file=zfile, sheetName="multiSpp", append=TRUE, row.names=FALSE)
  }
append.focfail=function(){
  focal_fail_dates_wide <- as.data.frame(focal_fail_dates_wide)
  write.xlsx(focal_fail_dates_wide, file=zfile, sheetName="focal_fail_dates", append=TRUE, row.names=FALSE)
}
append.visits=function(){
  write.xlsx(visits, file=zfile, sheetName="visits", append=TRUE, row.names=FALSE)
}



## now export the base scoring file
export.hep()
## and append the desired nest sheets to it
append.all.spp()
append.bcnh()
append.caeg()
append.greg()
append.sneg()
append.gbhe()
append.dcco()
append.multi.spp()
append.focfail()


## YOU SHOULD BE DONE HERE








############################################################################################################

### these generally won't be needed, but these are some functions for appending single worksheets to a file that already exists
## you'll have to delete that sheet if it already exists in the file
append.visits=function(seas, col){
  visits <- as.data.frame(visits)
  write.xlsx(visits, file=zfile, sheetName="visits", append=TRUE, row.names=FALSE)
  }
append.visits(seas, col)

append.focfail=function(seas, col){
  focal_fail_dates_wide <- as.data.frame(focal_fail_dates_wide)
  write.xlsx(focal_fail_dates_wide, file=zfile, sheetName="focal_fail_dates", append=TRUE, row.names=FALSE)
  }
append.focfail(seas, col)

append.num.stage=function(seas, col){
  nest_num_stage <- as.data.frame(nest_num_stage)
  write.xlsx(nest_num_stage, file=zfile, sheetName="nest_num_stage", append=TRUE, row.names=FALSE)
  }
append.num.stage(seas, col)


  ########